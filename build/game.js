var glb={},SCREEN_WIDTH=W=640,SCREEN_HEIGHT=H=960,BULLET_APPEALANCE=.2*SCREEN_WIDTH,BULLET_SIZE=12,GL_QUALITY=.35,GL_PIXEL_WIDTH=~~(SCREEN_WIDTH*GL_QUALITY),GL_PIXEL_HEIGHT=~~(SCREEN_HEIGHT*GL_QUALITY),GL=WebGLRenderingContext,ASSETS={bullets:"./asset/bullets.png",particles:"./asset/particles.png",hime:"./asset/p32.obj",himetex:"./asset/p32.png",test:"./asset/test.png"};tm.main(function(){var a=tm.display.CanvasApp("#c2");a.fps=60,a.resize(SCREEN_WIDTH,SCREEN_HEIGHT).fitWindow().run(),a.glContext=glb.GLContext("#c3").resize(GL_PIXEL_WIDTH,GL_PIXEL_HEIGHT).fitWindow(),a.replaceScene(tm.game.LoadingScene({width:SCREEN_WIDTH,height:SCREEN_HEIGHT,assets:ASSETS,nextScene:glb.GameScene})),tm.asset.Script.loadStats().onload=function(){a.enableStats()}}),Number.prototype.toFloatString=function(){return this%1?""+this:""+this+".0"},tm.define("glb.ExplosionS",{superClass:"tm.app.Element",particleSystem:null,position:null,emitParFrame:0,param:null,init:function(a,b){this.superInit(),void 0===b&&(b=2),this.particleSystem=a,this.position=glb.Vector2(),this.emitParFrame=20,this.param={ttl:.002,sizeFrom:100,sizeTo:130,frameIndex:2,colorFrom:tm.graphics.Color(255,255,255,.2),colorTo:tm.graphics.Color(255,255,255,0)},tm.app.Element().addChildTo(this).tweener.to({emitParFrame:0},30,"easeOutQuad").call(function(){this.remove()}.bind(this))},update:function(){var a=this.particleSystem,b=this.param,c=this.position;this.emitParFrame.times(function(){b.velocityFrom=glb.Vector2().fromAngleLength(Math.randf(0,2*Math.PI),Math.randf(.5,6)),b.velocityTo=b.velocityFrom.clone().mul(.01),b.position=c.clone().add(b.velocityFrom),a.spawn(b)})},setPosition:function(a,b){return this.position.set(a,b),this},setPositionVector:function(a){return this.position=a,this}}),glb.ExplosionS.prototype.accessor("x",{set:function(a){this.position.x=x},get:function(){return this.position.x}}),glb.ExplosionS.prototype.accessor("y",{set:function(a){this.position.y=y},get:function(){return this.position.y}}),tm.define("glb.Flame",{superClass:"tm.app.Element",particleSystem:null,position:null,emitParFrame:0,param:null,init:function(a,b){this.superInit(),void 0===b&&(b=2),this.particleSystem=a,this.position=glb.Vector2(),this.emitParFrame=10,this.param={ttl:.002,sizeFrom:80,sizeTo:30,frameIndex:b,colorFrom:tm.graphics.Color(255,255,255,.5),colorTo:tm.graphics.Color(255,255,255,0)}},update:function(){var a=this.particleSystem,b=this.param,c=this.position;this.emitParFrame.times(function(){b.velocityFrom=glb.Vector2(0,Math.randf(1,8)),b.velocityTo=b.velocityFrom,b.position=glb.Vector2().random(c.x,c.y,0,25),a.spawn(b)})},setPosition:function(a,b){return this.position.set(a,b),this}}),glb.Flame.prototype.accessor("x",{set:function(a){this.position.x=x},get:function(){return this.position.x}}),glb.Flame.prototype.accessor("y",{set:function(a){this.position.y=y},get:function(){return this.position.y}}),tm.define("glb.Hud",{superClass:"tm.display.CanvasElement",init:function(){this.superInit()}}),function(){tm.graphics.Color.prototype.accessor("array",{set:function(a){this._array=a,this.r=~~(255*a[0]),this.g=~~(255*a[1]),this.b=~~(255*a[2]),this.a=a[3]},get:function(){null==this._array&&(this._array=new Float32Array(4));var a=this._array;return a[0]=this.r/255,a[1]=this.g/255,a[2]=this.b/255,a[3]=this.a,a}})}(),function(){tm.define("glb.MtlAsset",{superClass:"tm.event.EventDispatcher",init:function(){this.superInit()},load:function(a){this.url=a;var b=this,c={url:a,success:function(a){b.parse(a),b.flare("load")}};return tm.util.Ajax.load(c),this},parse:function(a){var b=a.split("\n");b.forEach(function(a){})}});var a=function(a){return glb.MtlAsset().load(a)};tm.asset.Loader.register("mtl",a)}(),function(){tm.define("glb.ObjAsset",{superClass:"tm.event.EventDispatcher",init:function(){this.superInit(),this.geometry=null,this.materials=null,this._vertices=[],this._faces=[],this._normals=[],this._texcoords=[],this._materialName=null},load:function(a){this.url=a;var b=this,c={url:a,success:function(a){b.parse(a),b.geometry=b.buildGeometry(),b.materials=b.buildMaterials(),b.flare("load")}};return tm.util.Ajax.load(c),this},parse:function(a){var b=this,c=a.split("\n");c.forEach(function(a){b.parseLine(a.trim())})},buildGeometry:function(){var a=glb.GeometryBuilder(),b=this._vertices;return this._faces.forEach(function(c){var d=glb.Face();[c.a,c.b,c.c].forEach(function(a,c){var e=b[a.index];d.setPositionIndex(c,e.x,e.y,e.z).setNormalIndex(c,a.normal.x,a.normal.y,a.normal.z).setUvIndex(c,a.texcoord.x,a.texcoord.y,a.texcoord.z)}),a.addFace(d)}),a.build()},buildMaterials:function(){},parseLine:function(a){var b;if(0!==a.length&&"#"!==a[0])if(b=a.match(/^usemtl (.+)$/))this._materialName=b[1];else if(b=a.match(/^mtllib (.+)$/)){var c=b[1],d=this.url.substring(0,this.url.lastIndexOf("/")),e=glb.MtlAsset().load(d+"/"+c),f=tm.asset.Loader(),g={};g[c]=e,f.load(g)}else{var h=a.substring(0,2);switch(h.trim()){case"vn":return void this.parseVn(a.substring(3));case"vt":return void this.parseVt(a.substring(3));case"v":return void this.parseV(a.substring(2));case"f":return void this.parseF(a.substring(2))}}},parseVn:function(a){var b=a.split(" ");this._normals.push({x:Number(b[0]),y:Number(b[1]),z:Number(b[2])})},parseVt:function(a){var b=a.split(" ");this._texcoords.push({x:Number(b[0]),y:Number(b[1])})},parseV:function(a){var b=a.split(" ");this._vertices.push({x:Number(b[0]),y:Number(b[1]),z:Number(b[2])})},parseF:function(a){var b=this,c=/^(-?\d+)\/(\d+)\/(\d+)$/,d=a.split(" ").map(function(a){var d;if(d=a.trim().match(c)){var e=Number(d[1]),f=Number(d[2]),g=Number(d[3]);return{index:0>e?b._vertices.length+e:e-1,texcoord:b._texcoords[f-1],normal:b._normals[g-1]}}});this._faces.push({a:d[0],b:d[1],c:d[2],materialName:this._materialName})}});var a=function(a){return glb.ObjAsset().load(a)};tm.asset.Loader.register("obj",a)}(),function(){tm.define("glb.Matrix3",{array:null,init:function(){this.array=mat3.create()},fromMat4:function(a){return mat3.fromMat4(this.array,a.array),this},clone:function(){var a=glb.Matrix3();return a.array=mat3.clone(this.array),a},identity:function(){return mat3.identity(this.array),this},transpose:function(){return mat3.transpose(this.array,this.array),this},invert:function(){return mat3.invert(this.array,this.array),this},adjoint:function(){return mat3.adjoint(this.array,this.array),this},determinant:function(){return mat3.determinant(this.array)},mul:function(a){return mat3.multiply(this.array,this.array,a.array),this},translate:function(a){return mat3.translate(this.array,this.array,a.array),this},scale:function(a){return mat3.scale(this.array,this.array,a.array),this},rotate:function(a,b){return mat3.rotate(this.array,this.array,a,b.array),this},fromTranslation:function(a){mat3.fromTranslation(this.array,a.array)},fromRotation:function(a){return mat3.fromRotation(this.array,a),this},fromScaling:function(a){return mat3.fromScaling(this.array,a.array),this},fromQuat:function(a){return mat3.fromQuat(this.array,a.array),this},normalFromMat4:function(a){return mat3.normalFromMat4(this.array,a.array),this}})}(),function(){tm.define("glb.Matrix4",{array:null,init:function(){this.array=mat4.create()},clone:function(){var a=glb.Matrix4();return a.array=mat4.clone(this.array),a},identity:function(){return mat4.identity(this.array),this},transpose:function(){return mat4.transpose(this.array,this.array),this},invert:function(){return mat4.invert(this.array,this.array),this},adjoint:function(){return mat4.adjoint(this.array,this.array),this},determinant:function(){return mat4.determinant(this.array)},mul:function(a){return mat4.multiply(this.array,this.array,a.array),this},translate:function(a){return mat4.translate(this.array,this.array,a.array),this},scale:function(a){return mat4.scale(this.array,this.array,a.array),this},rotate:function(a,b){return mat4.rotate(this.array,this.array,a,b.array),this},rotateX:function(a){return mat4.rotateX(this.array,this.array,a),this},rotateY:function(a){return mat4.rotateY(this.array,this.array,a),this},rotateZ:function(a){return mat4.rotateZ(this.array,this.array,a),this},fromTranslation:function(a){return mat4.fromTranslation(this.array,a.array),this},fromScaling:function(a){return mat4.fromScaling(this.array,a.array),this},fromRotation:function(a,b){return mat4.fromRotation(this.array,a,b.array),this},fromXRotation:function(a){return mat4.fromXRotation(this.array,a),this},fromYRotation:function(a){return mat4.fromYRotation(this.array,a),this},fromZRotation:function(a){return mat4.fromZRotation(this.array,a),this},fromRotationTranslation:function(a,b){return mat4.fromRotationTranslation(this.array,a.array,b.array),this},fromRotationTranslationScale:function(a,b,c){return mat4.fromRotationTranslationScale(this.array,a.array,b.array,c.array),this},fromRotationTranslationScaleOrigin:function(a,b,c,d){return mat4.fromRotationTranslationScaleOrigin(this.array,a.array,b.array,c.array,d.array),this},fromQuat:function(a){return mat4.fromQuat(this.array,a.array),this},frustum:function(a,b,c,d,e,f){return mat4.frustum(this.array,a,b,c,d,e,f),this},perspective:function(a,b,c,d){return mat4.perspective(this.array,a,b,c,d),this},perspectiveFromFieldOfView:function(a,b,c){return mat4.perspectiveFromFieldOfView(this.array,a,b,c),this},ortho:function(a,b,c,d,e,f){return mat4.ortho(this.array,a,b,c,d,e,f),this},lookAt:function(a,b,c){return mat4.lookAt(this.array,a.array,b.array,c.array),this}}),glb.Matrix4.mul=function(a,b){var c=glb.Matrix4();return mat4.mul(c.array,a.array,b.array),c}}(),function(){tm.define("glb.Quat",{array:null,init:function(a,b,c,d){this.array=quat.create(),this.set(a||0,b||0,c||0,d||1)},set:function(a,b,c,d){return quat.set(this.array,a,b,c,d),this},rotationTo:function(a,b){return quat.rotationTo(this.array,a.array,b.array),this},setAxes:function(a,b,c){return quat.setAxes(this.array,a.array,b.array,c.array),this},clone:function(){var a=glb.Quat();return quat.clone(a.array,this.array),a},identity:function(){return quat.identity(this.array),this},setAxisAngle:function(a,b){return quat.setAxisAngle(this.array,a.array,b),this},add:function(a){return quat.add(this.array,this.array,a.array),this},mul:function(a){return quat.multiply(this.array,this.array,a.array),this},rotateX:function(a){return quat.rotateX(this.array,this.array,a),this},rotateY:function(a){return quat.rotateY(this.array,this.array,a),this},rotateZ:function(a){return quat.rotateZ(this.array,this.array,a),this},calculateW:function(){return quat.calculateW(this.array,this.array),this},dot:function(a){return quat.dot(this.array,a.array)},slerp:function(a,b){return quat.slerp(this.array,this.array,a.array,b),this},invert:function(){return quat.invert(this.array,this.array),this},conjugate:function(){return quat.conjugate(this.array,this.array),this},length:function(){return quat.length(this.array)},squaredLength:function(){return quat.squaredLength(this.array)},normalize:function(){return quat.normalize(this.array,this.array),this},fromMat3:function(a){return quat.fromMat3(this.array,a.array),this}}),glb.Quat.slerp=function(a,b,c){var d=glb.Quat();return quat.slerp(d.array,a.array,b.array,c),d}}(),function(){tm.define("glb.Vector2",{init:function(a,b){this.array=vec2.create(),this.set(a||0,b||0)},clone:function(){return glb.Vector2(this.x,this.y)},copy:function(a){return this.set(a.x,a.y)},set:function(a,b){return vec2.set(this.array,a,b),this},add:function(a){return vec2.add(this.array,this.array,a.array),this},sub:function(a){return vec2.sub(this.array,this.array,a.array),this},mul:function(a){return vec2.scale(this.array,this.array,a),this},length:function(){return vec2.length(this.array)},squaredLength:function(){return vec2.squaredLength(this.array)},negate:function(){return vec2.negate(this.array,this.array),this},inverse:function(){return vec2.inverse(this.array,this.array),this},normalize:function(){return vec2.normalize(this.array,this.array),this},dot:function(a){return vec2.dot(this.array,a.array)},cross:function(a){var b=glb.Vector3();return vec2.cross(b.array,this.array,a.array),b},fromAngleLength:function(a,b){return this.set(Math.cos(a)*b,Math.sin(a)*b)},random:function(a,b,c,d){var e=Math.random()*Math.PI,f=Math.randf(c,d);return this.set(a+Math.cos(e)*f,b+Math.sin(e)*f)}}),glb.Vector2.prototype.accessor("x",{set:function(a){this.array[0]=a},get:function(){return this.array[0]}}),glb.Vector2.prototype.accessor("y",{set:function(a){this.array[1]=a},get:function(){return this.array[1]}}),glb.Vector2.distance=function(a,b){return vec2.distance(a.array,b.array)},glb.Vector2.squaredDistance=function(a,b){return vec2.squaredDistance(a.array,b.array)}}(),function(){tm.define("glb.Vector3",{array:null,init:function(a,b,c){this.array=vec3.create(),this.set(a||0,b||0,c||0)},set:function(a,b,c){return vec3.set(this.array,a,b,c),this},clone:function(){return glb.Vector3(this.x,this.y,this.z)},add:function(a){return vec3.add(this.array,this.array,a.array),this},sub:function(a){return vec3.sub(this.array,this.array,a.array),this},mul:function(a){return vec3.scale(this.array,a),this},length:function(){return vec3.length(this.array)},squaredLength:function(){return vec3.squaredLength(this.array)},negate:function(){return vec3.negate(this.array,this.array),this},inverse:function(){return vec3.inverse(this.array,this.array),this},normalize:function(){return vec3.normalize(this.array,this.array),this},dot:function(a){return vec3.dot(this.array,a.array)},cross:function(a){var b=glb.Vector3();return vec3.create(b.array,this.array,a.array),b},transformMat4:function(a){return vec3.transformMat4(this.array,this.array,a.array),this},transformMat3:function(a){return vec3.transformMat3(this.array,this.array,a.array),this},transformQuat:function(a){return vec3.transformQuat(this.array,this.array,a.array),this}}),glb.Vector3.prototype.accessor("x",{set:function(a){this.array[0]=a},get:function(){return this.array[0]}}),glb.Vector3.prototype.accessor("y",{set:function(a){this.array[1]=a},get:function(){return this.array[1]}}),glb.Vector3.prototype.accessor("z",{set:function(a){this.array[2]=a},get:function(){return this.array[2]}}),glb.Vector3.distance=function(a,b){return vec3.distance(a.array,b.array)},glb.Vector3.squaredDistance=function(a,b){return vec3.squaredDistance(a.array,b.array)},glb.Vector3.angle=function(a,b){return vec3.angle(a.array,b.array)},glb.Vector3.add=function(a,b){var c=glb.Vector3();return vec3.add(c.array,a.array,b.array),c},glb.Vector3.sub=function(a,b){var c=glb.Vector3();return vec3.sub(c.array,a.array,b.array),c},glb.Vector3.mul=function(a,b){var c=glb.Vector3().copy(a);return c.mul(b)},glb.Vector3.distance=function(a,b){return vec3.distance(a.array,b.array)},glb.Vector3.squaredDistance=function(a,b){return vec3.squaredDistance(a.array,b.array)},glb.Vector3.negate=function(a){var b=glb.Vector3();return vec3.negate(glb.Vector3.array,a.array),b},glb.Vector3.inverse=function(a){var b=glb.Vector3();return vec3.inverse(glb.Vector3.array,a.array),b},glb.Vector3.normalize=function(a){var b=glb.Vector3();return vec3.normalize(glb.Vector3.array,a.array),b},glb.Vector3.transformMat4=function(a,b){var c=glb.Vector3().copy(a);return vec3.transformMat4(c.array,c.array,b.array),c},glb.Vector3.transformMat3=function(a,b){var c=glb.Vector3().copy(a);return vec3.transformMat3(c.array,c.array,b.array),c},glb.Vector3.transformQuat=function(a,b){var c=glb.Vector3().copy(a);return vec3.transformQuat(c.array,c.array,b.array),c},glb.Vector3.X=glb.Vector3(1,0,0),glb.Vector3.Y=glb.Vector3(0,1,0),glb.Vector3.Z=glb.Vector3(0,0,1)}(),function(){tm.define("glb.Camera",{position:null,target:null,up:null,vMatrix:null,pMatrix:null,vpMatrix:null,init:function(){this.position=glb.Vector3(0,0,10),this.target=glb.Vector3(),this.up=glb.Vector3(0,1,0),this.vMatrix=glb.Matrix4(),this.pMatrix=this._setupProjectionMatrix(),this.vpMatrix=glb.Matrix4(),this.updateMatrix(),this._defineAccessors()},_setupProjectionMatrix:function(){return glb.Matrix4()},_defineAccessors:function(){this.accessor("x",{set:function(a){this.position.x=a},get:function(){return this.position.x}}),this.accessor("y",{set:function(a){this.position.y=a},get:function(){return this.position.y}}),this.accessor("z",{set:function(a){this.position.z=a},get:function(){return this.position.z}})},setPosition:function(a,b,c){this.position.set(a,b,c),this.updateMatrix()},calcVpMatrix:function(){return this.vpMatrix=glb.Matrix4.mul(this.pMatrix,this.vMatrix),this.vpMatrix},updateMatrix:function(){this.vMatrix.lookAt(this.position,this.target,this.up)},getScreenCoord:function(a){var b=vec4.set(vec4.create(),a.x,a.y,0,1);vec4.transformMat4(b,b,this.vpMatrix.array);var c=b[0]/b[3],d=b[1]/b[3];return glb.Vector2(.5*(c+1),.5*(d+1))}})}(),tm.define("glb.OrthoCamera",{superClass:"glb.Camera",init:function(a,b,c,d,e,f){this.left=a,this.right=b,this.bottom=c,this.top=d,this.near=e,this.far=f,this.superInit()},_setupProjectionMatrix:function(){return glb.Matrix4().ortho(this.left,this.right,this.bottom,this.top,this.near,this.far)}}),tm.define("glb.PerspectiveCamera",{superClass:"glb.Camera",init:function(a,b,c,d){this.fovy=a,this.aspect=b,this.near=c,this.far=d,this.superInit()},_setupProjectionMatrix:function(){return glb.Matrix4().perspective(this.fovy,this.aspect,this.near,this.far)}}),tm.define("glb.DirectionalLight",{superClass:"tm.app.Element",position:null,init:function(){this.superInit()}}),function(){tm.define("glb.AfterEffectComposer",{glContext:null,passes:null,init:function(a){this.glContext=a,this.firstPass=glb.FirstPass(),this.endPass=glb.EndPass(),this.passes=[]},addPass:function(a){this.passes.push(a)},render:function(b,c){var d=this.glContext;if(0===this.passes.length||0===this.passes.filter(a).length)d.attachScreen(null),d.render(b,c);else{var e=this.passes.reduce(function(a,b){return b.enabled?b.render(d,a):a},this.firstPass.render(d,b,c));this.endPass.render(d,e)}}});var a=function(a){return a.enabled}}(),function(){tm.define("glb.BlurPass",{superClass:"glb.ShaderPass",init:function(){this.superInit(),this.previousFrameScreen=glb.Screen(),this.rect.mixFactor0=.8,this.rect.mixFactor1=.8,this.rect.mainMaterial=this.rect.material,this.rect.mixMaterial=glb.ScreenTextureMaterial(glb.MixShader()),this.rect.mixMaterial.setTextures=function(a){var b=a.gl;b.activeTexture(b.TEXTURE0),b.bindTexture(b.TEXTURE_2D,this.texture0),b.uniform1i(this.uniforms.texture0.location,0),b.activeTexture(b.TEXTURE1),b.bindTexture(b.TEXTURE_2D,this.texture1),b.uniform1i(this.uniforms.texture1.location,1)},this.rect.build=function(a){var b=a.gl,c=a.ext;this.geometry.build(a),this.mainMaterial.build(a),this.mixMaterial.build(a),null!==c&&(this.mainMaterial.setVao(a),this.mainMaterial.setAttributes(a,this.geometry),b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,this.geometry.index),this.mainMaterial.unsetVao(a),this.mixMaterial.setVao(a),this.mixMaterial.setAttributes(a,this.geometry),b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,this.geometry.index),this.mixMaterial.unsetVao(a))}},render:function(a,b){return this.isBuilt||(this.screen.build(a),this.previousFrameScreen.build(a),this.isBuilt=!0),this.rect.material=this.rect.mixMaterial,this.rect.material.texture0=this.previousFrameScreen.texture,this.rect.material.texture1=b.texture,a.attachScreen(this.screen),a.render(this.scene,this.camera),this.rect.material=this.rect.mainMaterial,this.rect.material.texture=this.screen.texture,a.attachScreen(this.previousFrameScreen),a.render(this.scene,this.camera),this.screen}})}(),tm.define("glb.EndPass",{superClass:"glb.ShaderPass",init:function(){this.superInit(),this.screen=null}}),tm.define("glb.FirstPass",{screen:null,isBuilt:!1,init:function(){this.screen=glb.Screen()},render:function(a,b,c){return this.isBuilt||(this.screen.build(a),this.isBuilt=!0),a.attachScreen(this.screen),a.render(b,c),this.screen}}),function(){tm.define("glb.DefaultShader",{init:function(){this.attributeMetaData=a,this.uniformMetaData=b,this.vertexShaderSource=c,this.fragmentShaderSource=d}});var a=[{name:"position",size:3},{name:"uv",size:2}],b=[{name:"mMatrix",type:"mat4"},{name:"vpMatrix",type:"mat4"},{name:"texture",type:"texture"}],c=["attribute vec3 position;","attribute vec2 uv;","uniform mat4 mMatrix;","uniform mat4 vpMatrix;","varying vec2 vUv;","void main(void) {","    vUv = vec2(uv.x, 1.0 - uv.y);","    gl_Position = vpMatrix * mMatrix * vec4(position, 1.0);","}"].join("\n"),d=["precision mediump float;","uniform sampler2D texture;","varying vec2 vUv;","void main(void) {","    gl_FragColor = texture2D(texture, vUv);","}"].join("\n")}(),function(){tm.define("glb.MixShader",{superClass:"glb.DefaultShader",init:function(){this.superInit(),this.uniformMetaData=[{name:"mMatrix",type:"mat4"},{name:"vpMatrix",type:"mat4"},{name:"texture0",type:"texture"},{name:"texture1",type:"texture"},{name:"mixFactor0",type:"float"},{name:"mixFactor1",type:"float"}],this.fragmentShaderSource=["precision mediump float;","uniform float mixFactor0;","uniform float mixFactor1;","uniform sampler2D texture0;","uniform sampler2D texture1;","varying vec2 vUv;","void main(void) {","    vec4 c0 = texture2D(texture0, vUv);","    vec4 c1 = texture2D(texture1, vUv);","    gl_FragColor = clamp(c0 * mixFactor0 + c1 * mixFactor1, 0.0, 1.0);","}"].join("\n")}})}(),function(){tm.define("glb.MonotoneShader",{superClass:"glb.DefaultShader",init:function(){this.superInit(),this.fragmentShaderSource=["precision mediump float;","uniform sampler2D texture;","varying vec2 vUv;","void main(void) {","    vec4 color = texture2D(texture, vUv);","    float c = (color.r + color.g + color.b) / 3.0;","    gl_FragColor = vec4(c, c, c, color.a);","}"].join("\n")}})}(),function(){tm.define("glb.ReverseShader",{superClass:"glb.DefaultShader",init:function(){this.superInit(),this.fragmentShaderSource=["precision mediump float;","uniform sampler2D texture;","varying vec2 vUv;","void main(void) {","    vec4 c = texture2D(texture, vUv);","    gl_FragColor = vec4(1.0 - c.r, 1.0 - c.g, 1.0 - c.b, c.a);","}"].join("\n")}})}(),function(){tm.define("glb.ShaderPass",{isBuilt:!1,screen:null,scene:null,camera:null,rect:null,enabled:!0,init:function(a){a=a||glb.DefaultShader(),this.screen=glb.Screen(),this.scene=tm.app.Scene(),this.camera=glb.OrthoCamera(-.5,.5,-.5,.5,1,20),this.rect=glb.Mesh(glb.PlaneGeometry(1),glb.ScreenTextureMaterial(a)).addChildTo(this.scene)},render:function(a,b){return!this.isBuilt&&this.screen&&(this.screen.build(a),this.isBuilt=!0),this.rect.material.texture=b.texture,a.attachScreen(this.screen),a.render(this.scene,this.camera),this.screen}})}(),tm.define("glb.BoxGeometry",{superClass:"glb.Geometry",position:null,uv:null,index:null,init:function(a,b,c){this.superInit(),a=a||1,b=b||a,c=c||a,a*=.5,b*=.5,c*=.5,this.positionData=new Float32Array([-a,b,-c,a,b,-c,-a,b,c,a,b,c,-a,-b,-c,a,-b,-c,-a,-b,c,a,-b,c]),this.uvData=new Float32Array([0,1,1,1,0,0,1,0,0,0,1,0,0,1,1,1]),this.indexData=new Int16Array([0,4,6,0,6,2,0,2,3,0,3,1,3,7,5,3,5,1,2,6,7,2,7,3,6,4,5,6,5,7,1,5,4,1,4,0])},build:function(a){var b=a.gl;this.position=this.createVbo(b,this.positionData),this.uv=this.createVbo(b,this.uvData),this.index=this.createIbo(b,this.indexData)}}),tm.define("glb.Geometry",{materialIndexData:null,positionData:null,normalData:null,uvData:null,vertexColorData:null,indexData:null,materialIndex:null,position:null,normal:null,uvData:null,vertexColor:null,index:null,init:function(){},build:function(a){var b=a.gl;this.materialIndex=this.createVbo(b,this.materialIndexData),this.position=this.createVbo(b,this.positionData),this.normal=this.createVbo(b,this.normalData),this.uv=this.createVbo(b,this.uvData),this.vertexColor=this.createVbo(b,this.vertexColorData),this.index=this.createIbo(b,this.indexData)},createVbo:function(a,b,c){c=c||GL.STATIC_DRAW;var d=a.createBuffer();return a.bindBuffer(a.ARRAY_BUFFER,d),a.bufferData(a.ARRAY_BUFFER,b,c),a.bindBuffer(a.ARRAY_BUFFER,null),d},transfarVbo:function(a,b,c,d,e){return d=d||0,e=e||GL.STATIC_DRAW,a.bindBuffer(a.ARRAY_BUFFER,b),a.bufferSubData(a.ARRAY_BUFFER,d,c),a.bindBuffer(a.ARRAY_BUFFER,null),b},createIbo:function(a,b,c){c=c||GL.STATIC_DRAW;var d=a.createBuffer();return a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,d),a.bufferData(a.ELEMENT_ARRAY_BUFFER,b,c),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,null),d}}),tm.define("glb.PlaneGeometry",{superClass:"glb.Geometry",position:null,uv:null,index:null,init:function(a,b,c){this.superInit(),a=a||32,b=b||1,c=c||1,this.positionData=new Float32Array([.5*-a,.5*-a,0,.5*a,.5*-a,0,.5*-a,.5*a,0,.5*a,.5*a,0]),this.uvData=new Float32Array([0,1/c,1/b,1/c,0,0,1/b,0]),this.indexData=new Int16Array([0,1,2,1,3,2])},build:function(a){var b=a.gl;this.position=this.createVbo(b,this.positionData),this.uv=this.createVbo(b,this.uvData),this.index=this.createIbo(b,this.indexData)}}),function(){tm.define("glb.Face",{init:function(){this.setUvA(0,0),this.setUvB(0,0),this.setUvC(0,0),this.setFaceColor(1,1,1,1)},setMaterialIndex:function(a){this.materialIndex=a},setPositionIndex:function(a,b,c,d){switch(a){case 0:return this.setPositionA(b,c,d);case 1:return this.setPositionB(b,c,d);case 2:return this.setPositionC(b,c,d)}},setPositionA:function(a,b,c){return this.positionA=[a,b,c],this},setPositionB:function(a,b,c){return this.positionB=[a,b,c],this},setPositionC:function(a,b,c){return this.positionC=[a,b,c],this},setNormalIndex:function(a,b,c,d){switch(a){case 0:return this.setNormalA(b,c,d);case 1:return this.setNormalB(b,c,d);case 2:return this.setNormalC(b,c,d)}},setNormalA:function(a,b,c){return this.normalA=[a,b,c],this},setNormalB:function(a,b,c){return this.normalB=[a,b,c],this},setNormalC:function(a,b,c){return this.normalC=[a,b,c],this},setFaceNormal:function(a,b,c){return this.normalA=[a,b,c],this.normalB=[a,b,c],this.normalC=[a,b,c],this},calcFaceNormal:function(){var b=vec3.set(a(),this.positionA[0],this.positionA[1],this.positionA[2]),c=vec3.set(a(),this.positionB[0],this.positionB[1],this.positionB[2]),d=vec3.set(a(),this.positionC[0],this.positionC[1],this.positionC[2]),e=vec3.sub(a(),c,b),f=vec3.sub(a(),d,b),g=vec3.cross(a(),e,f);return vec3.normalize(g,g),this.setFaceNormal(g[0],g[1],g[2]),this},setUvIndex:function(a,b,c){switch(a){case 0:return this.setUvA(b,c);case 1:return this.setUvB(b,c);case 2:return this.setUvC(b,c)}},setUvA:function(a,b){return this.uvA=[a,b],this},setUvB:function(a,b){return this.uvB=[a,b],this},setUvC:function(a,b){return this.uvC=[a,b],this},setColorIndex:function(a,b,c,d,e){switch(a){case 0:return this.setColorA(b,c,d,e);case 1:return this.setColorB(b,c,d,e);case 2:return this.setColorC(b,c,d,e)}},setColorA:function(a,b,c,d){return this.vertexColorA=[a,b,c,d],this},setColorB:function(a,b,c,d){return this.vertexColorB=[a,b,c,d],this},setColorC:function(a,b,c,d){return this.vertexColorC=[a,b,c,d],this},setFaceColor:function(a,b,c,d){return this.vertexColorA=[a,b,c,d],this.vertexColorB=[a,b,c,d],this.vertexColorC=[a,b,c,d],this},getVertex:function(a){switch(a){case 0:return this.getVertexA();case 1:return this.getVertexB();case 2:return this.getVertexC()}},getVertexA:function(){return{materialIndex:this.materialIndex,position:this.positionA,normal:this.normalA,uv:this.uvA,vertexColor:this.vertexColorA}},getVertexB:function(){return{materialIndex:this.materialIndex,position:this.positionB,normal:this.normalB,uv:this.uvB,vertexColor:this.vertexColorB}},getVertexC:function(){return{materialIndex:this.materialIndex,position:this.positionC,normal:this.normalC,uv:this.uvC,vertexColor:this.vertexColorC}}});var a=vec3.create}(),function(){tm.define("glb.GeometryBuilder",{init:function(){this.faces=[]},addFace:function(a){return this.faces.push(a),this},calcFaceNormals:function(){return this.faces.forEach(function(a){a.calcFaceNormal()}),this},build:function(){var b=glb.Geometry(),c=[],d=[],e=[];return this.faces.forEach(function(b,f){if(null==b.positionA||null==b.positionB||null==b.positionC)throw console.error(b),new Error("faceの頂点が欠けてる("+f+")");3..times(function(f){var g=b.getVertex(f),h=a(g),i=d.indexOf(h);0>i&&(i=c.length,c.push(g),d.push(h)),e.push(i)})}),b.materialIndexData=new Float32Array(c.map(function(a){return a.materialIndex}).flatten()),b.positionData=new Float32Array(c.map(function(a){return a.position}).flatten()),b.normalData=new Float32Array(c.map(function(a){return a.normal}).flatten()),b.uvData=new Float32Array(c.map(function(a){return a.uv}).flatten()),b.vertexColorData=new Float32Array(c.map(function(a){return a.vertexColor}).flatten()),b.indexData=new Int16Array(e),b}});var a=function(a){var b=1,c=31;return b=c*~~b+a.materialIndex,b=c*~~b+1e3*a.position[0],b=c*~~b+1e3*a.position[1],b=c*~~b+1e3*a.position[2],b=c*~~b+1e3*a.normal[0],b=c*~~b+1e3*a.normal[1],b=c*~~b+1e3*a.normal[2],b=c*~~b+1e3*a.uv[0],b=c*~~b+1e3*a.uv[1],b=c*~~b+1e3*a.vertexColor[0],b=c*~~b+1e3*a.vertexColor[1],b=c*~~b+1e3*a.vertexColor[2],b=c*~~b+1e3*a.vertexColor[3],""+b}}(),tm.define("glb.GLContext",{element:null,gl:null,ext:null,screen:null,init:function(a){this.element=window.document.querySelector(a),this.gl=this.element.getContext("webgl",{preserveDrawingBuffer:!0}),this.ext=this.gl.getExtension("OES_vertex_array_object"),null==this.ext&&console.warn("VAOはサポートされてない！");var b=this.gl;b.clearColor(0,0,0,1),b.clearDepth(1),b.enable(b.DEPTH_TEST),b.depthFunc(b.LEQUAL),b.enable(b.CULL_FACE),b.enable(b.BLEND),b.blendFunc(b.SRC_ALPHA,b.ONE_MINUS_SRC_ALPHA)},resize:function(a,b){return this.width=this.element.width=a,this.height=this.element.height=b,this.gl.viewport(0,0,a,b),this},fitWindow:function(a){var b=function(){a=void 0===a?!0:a;var b=this.element,c=b.style;c.position="absolute",c.margin="auto",c.left="0px",c.top="0px",c.bottom="0px",c.right="0px";var d=b.width/window.innerWidth,e=b.height/window.innerHeight,f=b.height/b.width;d>e?(c.width=innerWidth.floor()+"px",c.height=(innerWidth*f).floor()+"px"):(c.width=(innerHeight/f).floor()+"px",c.height=innerHeight.floor()+"px")}.bind(this);return b(),a&&window.addEventListener("resize",b,!1),this},createTexture:function(a,b){b=b||0;var c=this.gl;c.activeTexture(c.TEXTURE0+b);var d=c.createTexture();return c.bindTexture(c.TEXTURE_2D,d),c.texImage2D(c.TEXTURE_2D,0,c.RGBA,c.RGBA,c.UNSIGNED_BYTE,a),c.generateMipmap(c.TEXTURE_2D),c.bindTexture(c.TEXTURE_2D,null),d},attachScreen:function(a){var b=this.gl;return this.screen=a,a?(b.bindFramebuffer(b.FRAMEBUFFER,a.frameBuffer),b.viewport(0,0,a.width,a.height)):(b.bindFramebuffer(b.FRAMEBUFFER,null),b.viewport(0,0,this.width,this.height)),this},build:function(a){this.buildObj(a)},buildObj:function(a){var b=this;a.isBuilt||(a.build&&a.build(this),a.isBuilt=!0),a.children.forEach(function(a){b.buildObj(a)})},render:function(a,b){var c=this.gl;c.clear(c.COLOR_BUFFER_BIT|c.DEPTH_BUFFER_BIT),this.renderObj(a,b.calcVpMatrix()),c.flush()},renderObj:function(a,b){var c=this;a.isBuilt||(a.build&&a.build(this),a.isBuilt=!0),a.render&&a.visible&&a.render(this,b),a.children.forEach(function(a){c.renderObj(a,b)})}}),function(){tm.define("glb.BasicMaterial",{superClass:"glb.Material",color:null,_image:null,texture:null,init:function(b){this.superInit(),b={}.$extend(a,b),this.color=b.color,this._image=b.image},setColor:function(a){return this.color=a,this},build:function(a){this._createProgram(a),this._image&&(this.texture=a.createTexture(this._image))},_getVertexShaderSource:function(){return d},_getFragmentShaderSource:function(){return e},_getAttributeMetaData:function(){return b},_getUniformMetaData:function(){return c},setAttributes:function(a,b){this.superSetAttributes(a,b)},setTextures:function(a){var b=a.gl;this.texture?(b.activeTexture(b.TEXTURE0),b.bindTexture(b.TEXTURE_2D,this.texture)):b.bindTexture(b.TEXTURE_2D,null)},setUniforms:function(a,b){this.superSetUniforms(a,b),this.setUniform(a,"color",this.color),this.setUniform(a,"useTexture",this.texture?1:0)},draw:function(a,b){var c=a.gl;c.drawElements(c.TRIANGLES,b,c.UNSIGNED_SHORT,0)}});var a={color:tm.graphics.Color(255,255,255,1),image:null},b=[{name:"position",size:3},{name:"uv",size:2}],c=[{name:"mMatrix",type:"mat4"
},{name:"vpMatrix",type:"mat4"},{name:"texture",type:"texture"},{name:"uvTranslate",type:"vec2"},{name:"color",type:"color"},{name:"useTexture",type:"int"}],d=["attribute vec3 position;","attribute vec2 uv;","uniform mat4 mMatrix;","uniform mat4 vpMatrix;","uniform vec4 color;","varying vec2 vUv;","varying vec4 vColor;","void main(void) {","    vUv = uv;","    vColor = color;","    gl_Position = vpMatrix * mMatrix * vec4(position, 1.0);","}"].join("\n"),e=["precision mediump float;","uniform sampler2D texture;","uniform vec2 uvTranslate;","uniform int useTexture;","varying vec2 vUv;","varying vec4 vColor;","void main(void) {","    if (bool(useTexture)) {","        gl_FragColor = vColor * texture2D(texture, uvTranslate + vUv);","    } else {","        gl_FragColor = vColor;","    }","}"].join("\n")}(),function(){tm.define("glb.Material",{program:null,vao:null,attributes:null,uniforms:null,init:function(){},build:function(a){this._createProgram(a)},_getVertexShaderSource:function(){return c},_getFragmentShaderSource:function(){return d},_getAttributeMetaData:function(){return a},_getUniformMetaData:function(){return b},_createProgram:function(a){var b=a.gl,c=a.ext,d=this._createShader(b,b.VERTEX_SHADER,this._getVertexShaderSource()),e=this._createShader(b,b.FRAGMENT_SHADER,this._getFragmentShaderSource());if(this.program=b.createProgram(),b.attachShader(this.program,d),b.attachShader(this.program,e),b.linkProgram(this.program),!b.getProgramParameter(this.program,b.LINK_STATUS))throw new Error(b.getProgramInfoLog(this.program));return null!==c&&(this.vao=c.createVertexArrayOES()),this.attributes=this._getAttributeMetaData().reduce(function(a,c){return a[c.name]={name:c.name,size:c.size,location:b.getAttribLocation(this.program,c.name)},a}.bind(this),{}),this.uniforms=this._getUniformMetaData().reduce(function(a,c){return a[c.name]={name:c.name,type:c.type,location:b.getUniformLocation(this.program,c.name)},a}.bind(this),{}),this},_createShader:function(a,b,c){var d=a.createShader(b);return a.shaderSource(d,c),a.compileShader(d),a.getShaderParameter(d,a.COMPILE_STATUS)?d:void console.error(a.getShaderInfoLog(d))},setProgram:function(a){var b=a.gl;b.useProgram(this.program)},setVao:function(a){var b=a.ext;null!==b&&b.bindVertexArrayOES(this.vao)},unsetVao:function(a){var b=a.ext;null!==b&&b.bindVertexArrayOES(null)},setAttributes:function(a,b){var c=a.gl,d=this.attributes;Object.keys(this.attributes).forEach(function(a){var e=d[a];b[a]&&(c.bindBuffer(c.ARRAY_BUFFER,b[a]),c.enableVertexAttribArray(e.location),c.vertexAttribPointer(e.location,e.size,c.FLOAT,!1,0,0))})},setTextures:function(a){},setUniforms:function(a,b){var c=(a.gl,this),d=this.uniforms;Object.keys(this.uniforms).forEach(function(e){d[e];b[e]&&c.setUniform(a,e,b[e])})},setUniform:function(a,b,c){var d=a.gl,e=this.uniforms[b];if(c.array&&(c=c.array),e)switch(e.type){case"float":d.uniform1f(e.location,c);break;case"int":case"texture":d.uniform1i(e.location,c);break;case"vec2":d.uniform2fv(e.location,c);break;case"vec3":d.uniform3fv(e.location,c);break;case"vec4":case"color":d.uniform4fv(e.location,c);break;case"mat3":d.uniformMatrix3fv(e.location,!1,c);break;case"mat4":d.uniformMatrix4fv(e.location,!1,c)}},draw:function(a,b){}}),glb.Material.prototype.superSetAttributes=glb.Material.prototype.setAttributes,glb.Material.prototype.superSetUniforms=glb.Material.prototype.setUniforms;var a=[],b=[],c=["void main(void) {","    gl_Position = vec4(1.0);","}"].join("\n"),d=["precision mediump float;","void main(void) {","    gl_FragColor = vec4(1.0, 1.0, 1.0, 1.0);","}"].join("\n")}(),function(){tm.define("glb.ScreenTextureMaterial",{superClass:"glb.Material",texture:null,init:function(a){this.superInit(),this._vertexShaderSource=a.vertexShaderSource,this._fragmentShaderSource=a.fragmentShaderSource,this._attributeMetaData=a.attributeMetaData,this._uniformMetaData=a.uniformMetaData},_getVertexShaderSource:function(){return this._vertexShaderSource},_getFragmentShaderSource:function(){return this._fragmentShaderSource},_getAttributeMetaData:function(){return this._attributeMetaData},_getUniformMetaData:function(){return this._uniformMetaData},setTextures:function(a){var b=a.gl;b.activeTexture(b.TEXTURE0),b.bindTexture(b.TEXTURE_2D,this.texture)},draw:function(a,b){var c=a.gl;c.drawElements(c.TRIANGLES,b,c.UNSIGNED_SHORT,0)}})}(),function(){tm.define("glb.Mesh",{superClass:"glb.Object3D",mMatrix:null,vpMatrix:null,uvTranslate:null,position:null,rotation:null,scale:null,geometry:null,material:null,visible:!0,needsUpdate:!1,init:function(a,b){this.superInit(),this.mMatrix=glb.Matrix4(),this.uvTranslate=glb.Vector2(),this.position=glb.Vector3(),this.rotation=glb.Quat(),this.scale=glb.Vector3(1,1,1),this.geometry=a,this.material=b,this.updateMatrix(),this._defineAccessors()},setGeometry:function(a){return this.geometry=a,this},getMaterial:function(a){return this.material=a,this},_defineAccessors:function(){this.accessor("x",{set:function(a){this.position.x=a,this.needsUpdate=!0},get:function(){return this.position.x}}),this.accessor("y",{set:function(a){this.position.y=a,this.needsUpdate=!0},get:function(){return this.position.y}}),this.accessor("z",{set:function(a){this.position.z=a,this.needsUpdate=!0},get:function(){return this.position.z}}),this.accessor("scaleX",{set:function(a){this.scale.x=a,this.needsUpdate=!0},get:function(){return this.scale.x}}),this.accessor("scaleY",{set:function(a){this.scale.y=a,this.needsUpdate=!0},get:function(){return this.scale.y}}),this.accessor("scaleZ",{set:function(a){this.scale.z=a,this.needsUpdate=!0},get:function(){return this.scale.z}})},build:function(a){var b=a.gl,c=a.ext;this.geometry.build(a),this.material.build(a),null!==c&&(this.material.setVao(a),this.material.setAttributes(a,this.geometry),b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,this.geometry.index),this.material.unsetVao(a))},updateMatrix:function(){return this.mMatrix.fromRotationTranslationScale(this.rotation,this.position,this.scale),this.needsUpdate=!1,this},render:function(a,b){var c=a.gl,d=a.ext;this.updateMatrix(),this.material.setProgram(a),null!==d?this.material.setVao(a):(this.material.setAttributes(a,this.geometry),c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,this.geometry.index)),this.material.setTextures(a),this.material.setUniforms(a,this),this.material.setUniform(a,"vpMatrix",b),this.material.draw(a,this.geometry.indexData.length),null!==d&&this.material.unsetVao(a)},setPosition:function(a,b,c){return this.position.set(a,b,c),this.needsUpdate=!0,this},setScale:function(a,b,c){return 1===arguments.length&&(b=a,c=a),this.scale.set(a,b,c),this.needsUpdate=!0,this},setRotationX:function(a){return this.rotation.setAxisAngle(glb.Vector3.X,a),this.needsUpdate=!0,this},setRotationY:function(a){return this.rotation.setAxisAngle(glb.Vector3.Y,a),this.needsUpdate=!0,this},setRotationZ:function(a){return this.rotation.setAxisAngle(glb.Vector3.Z,a),this.needsUpdate=!0,this},translate:function(a,b,c){return this.position.x+=a,this.position.y+=b,this.position.z+=c,this.needsUpdate=!0,this},scale:function(a,b,c){return 1===arguments.length&&(b=a,c=a),this.scale.x*=a,this.scale.y*=b,this.scale.z*=c,this.needsUpdate=!0,this},rotateX:function(a){return this.rotation.rotateX(a),this.needsUpdate=!0,this},rotateY:function(a){return this.rotation.rotateY(a),this.needsUpdate=!0,this},rotateZ:function(a){return this.rotation.rotateZ(a),this.needsUpdate=!0,this}})}(),tm.define("glb.Object3D",{superClass:"tm.app.Element",init:function(){this.superInit()},build:function(a){},render:function(a,b){}}),tm.define("glb.Screen",{frameBuffer:null,depthRenderBuffer:null,texture:null,init:function(a,b){this.width=a||512,this.height=b||512},build:function(a){var b=a.gl;return this.frameBuffer=b.createFramebuffer(),this.texture=b.createTexture(),this.depthRenderBuffer=b.createRenderbuffer(),b.bindFramebuffer(b.FRAMEBUFFER,this.frameBuffer),b.bindTexture(b.TEXTURE_2D,this.texture),b.texImage2D(b.TEXTURE_2D,0,b.RGBA,this.width,this.height,0,b.RGBA,b.UNSIGNED_BYTE,null),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.LINEAR),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.LINEAR),b.framebufferTexture2D(b.FRAMEBUFFER,b.COLOR_ATTACHMENT0,b.TEXTURE_2D,this.texture,0),b.bindRenderbuffer(b.RENDERBUFFER,this.depthRenderBuffer),b.renderbufferStorage(b.RENDERBUFFER,b.DEPTH_COMPONENT16,this.width,this.height),b.framebufferRenderbuffer(b.FRAMEBUFFER,b.DEPTH_ATTACHMENT,b.RENDERBUFFER,this.depthRenderBuffer),b.bindRenderbuffer(b.RENDERBUFFER,null),b.bindTexture(b.TEXTURE_2D,null),b.bindFramebuffer(b.FRAMEBUFFER,null),this}}),function(){tm.define("glb.Bullets",{superClass:"glb.Object3D",geometry:null,material:null,_mainMaterial:null,_collisionMaterial:null,time:0,bullets:null,visible:!0,init:function(a){this.superInit(),this.geometry=glb.BulletsGeometry(),this._mainMaterial=glb.BulletsMaterial(a),this._collisionMaterial=glb.BulletsCollisionMaterial(),this.switchMaterial(!0),this.bullets=[]},switchMaterial:function(a){this.material=a?this._mainMaterial:this._collisionMaterial},build:function(a){var b=(a.gl,a.ext);this.geometry.build(a),this._mainMaterial.build(a),this._collisionMaterial.build(a),null!==b&&(this._mainMaterial.setVao(a),this._mainMaterial.setAttributes(a,this.geometry),this._mainMaterial.unsetVao(a),this._collisionMaterial.setVao(a),this._collisionMaterial.setAttributes(a,this.geometry),this._collisionMaterial.unsetVao(a)),this.isBuilt=!0},update:function(a){this.time+=1e-4;var b=this;this.bullets=this.bullets.filter(function(a){return a.position.add(a.velocity),a.position.x<(SCREEN_WIDTH+128)*-.5||.5*(SCREEN_WIDTH+128)<a.position.x||a.position.y<(SCREEN_HEIGHT+128)*-.5||.5*(SCREEN_HEIGHT+128)<a.position.y?(b.despawn(a.index),!1):!0})},render:function(a,b){var c=a.gl,d=a.ext;this.geometry.vboNeedUpdate&&(this.geometry.rebind(c),this.geometry.vboNeedUpdate=!1),this.material.setProgram(a),null!==d?this.material.setVao(a):this.material.setAttributes(a,this.geometry),this.material.setTextures(a),this.material.setUniforms(a,this),this.material.setUniform(a,"time",this.time),this.material.setUniform(a,"vpMatrix",b),this.material.draw(a,this.geometry.COUNT),null!==d&&this.material.unsetVao(a)},spawn:function(a,b,c){var d=this.geometry.spawn(this.time,a,b,c);if(!(0>d))return this.bullets.push({position:a,velocity:b,index:d}),d},despawn:function(a){this.geometry.despawn(a)}})}(),function(){tm.define("glb.BulletsCollisionMaterial",{superClass:"glb.Material",init:function(){this.superInit()},_getVertexShaderSource:function(){return c},_getFragmentShaderSource:function(){return d},_getAttributeMetaData:function(){return a},_getUniformMetaData:function(){return b},draw:function(a,b){var c=a.gl;c.drawArrays(c.POINTS,0,b)}});var a=[{name:"initialPosition",size:2},{name:"velocity",size:2},{name:"spawnTime",size:1},{name:"active",size:1}],b=[{name:"vpMatrix",type:"mat4"},{name:"time",type:"float"}],c=["attribute vec2 initialPosition;","attribute vec2 velocity;","attribute float spawnTime;","attribute float active;","uniform mat4 vpMatrix;","uniform float time;","varying float vActive;","void main(void) {","    vActive = active;","    if (active < 0.5) {","        gl_Position = vec4(0.0);","        gl_PointSize = 0.0;","    } else {","        float age = time - spawnTime;","        vec2 pos = initialPosition + velocity * age * 10000.0;","        gl_Position = vpMatrix * vec4(pos, 0.0, 1.0);","        gl_PointSize = {0};".format(BULLET_SIZE.toFloatString()),"    }","}"].join("\n"),d=["precision mediump float;","varying float vActive;","void main(void) {","    if (vActive < 0.5) discard;","    if (0.2 < length(gl_PointCoord - vec2(0.5, 0.5))) discard;","    gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);","}"].join("\n")}(),function(){tm.define("glb.BulletsGeometry",{superClass:"glb.Geometry",COUNT:8192,bufferUsage:1,initialPositionData:null,velocityData:null,spawnTimeData:null,activeData:null,frameIndexData:null,initialPosition:null,velocity:null,spawnTime:null,active:null,frameIndex:null,vboNeedUpdate:!1,init:function(){this.superInit(),this.initialPositionData=new Float32Array(Array.range(0,this.COUNT).map(function(){return[0,0]}).flatten()),this.velocityData=new Float32Array(Array.range(0,this.COUNT).map(function(){return[0,0]}).flatten()),this.spawnTimeData=new Float32Array(Array.range(0,this.COUNT).map(function(){return 0})),this.activeData=new Float32Array(Array.range(0,this.COUNT).map(function(){return 0})),this.frameIndexData=new Float32Array(Array.range(0,this.COUNT).map(function(){return 0}))},build:function(a){var b=a.gl;this.initialPosition=this.createVbo(b,this.initialPositionData,b.DYNAMIC_DRAW),this.velocity=this.createVbo(b,this.velocityData,b.DYNAMIC_DRAW),this.spawnTime=this.createVbo(b,this.spawnTimeData,b.DYNAMIC_DRAW),this.active=this.createVbo(b,this.activeData,b.DYNAMIC_DRAW),this.frameIndex=this.createVbo(b,this.frameIndexData,b.DYNAMIC_DRAW)},rebind:function(a){this.transfarVbo(a,this.initialPosition,this.initialPositionData),this.transfarVbo(a,this.velocity,this.velocityData),this.transfarVbo(a,this.spawnTime,this.spawnTimeData),this.transfarVbo(a,this.active,this.activeData),this.transfarVbo(a,this.frameIndex,this.frameIndexData)},spawn:function(a,c,d,e){var f=b(this.activeData,0);return 0>f?(console.warn("弾が足りない"),-1):(this.initialPositionData[2*f+0]=c.x,this.initialPositionData[2*f+1]=c.y,this.velocityData[2*f+0]=d.x,this.velocityData[2*f+1]=d.y,this.spawnTimeData[f]=a,this.activeData[f]=1,this.frameIndexData[f]=e,this.vboNeedUpdate=!0,f)},despawn:function(a){a<this.activeData.length&&(this.activeData[a]=0,this.vboNeedUpdate=!0)}});var a=0,b=function(b,c){for(var d=a,e=b.length;e>a;a++)if(b[a]===c)return a;for(a=0;d>a;a++)if(b[a]===c)return a;return a=0,-1}}(),function(){tm.define("glb.BulletsMaterial",{superClass:"glb.Material",_image:null,texture:null,init:function(a){this.superInit(),this._image=a},build:function(a){this._createProgram(a),this._image&&(this.texture=a.createTexture(this._image))},_getVertexShaderSource:function(){return c},_getFragmentShaderSource:function(){return d},_getAttributeMetaData:function(){return a},_getUniformMetaData:function(){return b},setTextures:function(a){var b=a.gl;this.texture?(b.activeTexture(b.TEXTURE0),b.bindTexture(b.TEXTURE_2D,this.texture)):b.bindTexture(b.TEXTURE_2D,null)},setUniforms:function(a,b){this.superSetUniforms(a,b),this.setUniform(a,"useTexture",this.texture?1:0)},draw:function(a,b){var c=a.gl;c.disable(c.DEPTH_TEST),c.disable(c.CULL_FACE),c.drawArrays(c.POINTS,0,b),c.enable(c.DEPTH_TEST),c.enable(c.CULL_FACE)}});var a=[{name:"initialPosition",size:2},{name:"velocity",size:2},{name:"spawnTime",size:1},{name:"active",size:1},{name:"frameIndex",size:1}],b=[{name:"vpMatrix",type:"mat4"},{name:"time",type:"float"}],c=["attribute vec2 initialPosition;","attribute vec2 velocity;","attribute float spawnTime;","attribute float active;","attribute float frameIndex;","uniform mat4 vpMatrix;","uniform float time;","varying float vAge;","varying float vActive;","varying float vFrameIndex;","varying float vAngle;","varying mat3 vUvMat;","mat3 translate(float x, float y) {","    return mat3(","        1.0, 0.0, 0.0,","        0.0, 1.0, 0.0,","          x,   y, 1.0","    );","}","mat3 rotate(float rad) {","    float s = sin(rad);","    float c = cos(rad);","    return mat3(","        c, s, 0,","       -s, c, 0,","        0, 0, 1","    );","}","void main(void) {","    vActive = active;","    vFrameIndex = frameIndex;","    if (active < 0.5) {","        vAngle = 0.0;","        gl_Position = vec4(0.0);","        gl_PointSize = 0.0;","    } else {","        if (frameIndex < 8.0) {","            vAngle = atan(velocity.y, velocity.x);","        } else {","            vAngle = time * 3000.0;","        }","        vAge = time - spawnTime;","        vUvMat = translate(0.5, 0.5) * rotate(vAngle) * translate(-0.5, -0.5);","        vec2 pos = initialPosition + velocity * ((time - spawnTime) * 10000.0);","        gl_Position = vpMatrix * vec4(pos, 0.0, 1.0);","        float c = sin(vAge * 5500.0) * 4.0 - 2.0;","        gl_PointSize = ({0} + c) * {1};".format(BULLET_APPEALANCE.toFloatString(),GL_QUALITY.toFloatString()),"    }","}"].join("\n"),d=["precision mediump float;","uniform sampler2D texture;","varying float vAge;","varying float vActive;","varying float vFrameIndex;","varying float vAngle;","varying mat3 vUvMat;","void main(void) {","    if (vActive < 0.5) discard;","    if (0.7 < length(gl_PointCoord - vec2(0.5, 0.5))) discard;","    vec3 buv = vec3(gl_PointCoord.x, gl_PointCoord.y, 1.0);","    vec3 ruv = vUvMat * buv;","    vec2 uv = vec2((ruv.x + vFrameIndex) * 0.0625, ruv.y);","    float c = sin(vAge * 6200.0) * 0.12;","    vec4 light = vec4(0.0, c, 0.0, 0.0);","    gl_FragColor = light + texture2D(texture, uv);","}"].join("\n")}(),function(){tm.define("glb.ParticleGeometry",{superClass:"glb.Geometry",COUNT:8192,bufferUsage:1,initialPositionData:null,velocityFromData:null,velocityToData:null,spawnTimeData:null,activeData:null,frameIndexData:null,ttlData:null,sizeFromData:null,sizeToData:null,colorFromData:null,colorToData:null,initialPosition:null,velocityFrom:null,velocityTo:null,spawnTime:null,active:null,frameIndex:null,ttl:null,sizeFrom:null,sizeTo:null,colorFrom:null,colorTo:null,vboNeedUpdate:!1,init:function(){this.superInit(),this.initialPositionData=new Float32Array(Array.range(0,this.COUNT).map(function(){return[0,0]}).flatten()),this.velocityFromData=new Float32Array(Array.range(0,this.COUNT).map(function(){return[0,0]}).flatten()),this.velocityToData=new Float32Array(Array.range(0,this.COUNT).map(function(){return[0,0]}).flatten()),this.spawnTimeData=new Float32Array(Array.range(0,this.COUNT).map(function(){return 0})),this.activeData=new Float32Array(Array.range(0,this.COUNT).map(function(){return 0})),this.frameIndexData=new Float32Array(Array.range(0,this.COUNT).map(function(){return 0})),this.ttlData=new Float32Array(Array.range(0,this.COUNT).map(function(){return 0})),this.sizeFromData=new Float32Array(Array.range(0,this.COUNT).map(function(){return 0})),this.sizeToData=new Float32Array(Array.range(0,this.COUNT).map(function(){return 0})),this.colorFromData=new Float32Array(Array.range(0,this.COUNT).map(function(){return[1,1,1,1]}).flatten()),this.colorToData=new Float32Array(Array.range(0,this.COUNT).map(function(){return[0,0,0,0]}).flatten())},build:function(a){var b=a.gl;this.initialPosition=this.createVbo(b,this.initialPositionData,b.DYNAMIC_DRAW),this.velocityFrom=this.createVbo(b,this.velocityFromData,b.DYNAMIC_DRAW),this.velocityTo=this.createVbo(b,this.velocityToData,b.DYNAMIC_DRAW),this.spawnTime=this.createVbo(b,this.spawnTimeData,b.DYNAMIC_DRAW),this.active=this.createVbo(b,this.activeData,b.DYNAMIC_DRAW),this.frameIndex=this.createVbo(b,this.frameIndexData,b.DYNAMIC_DRAW),this.ttl=this.createVbo(b,this.ttlData,b.DYNAMIC_DRAW),this.sizeFrom=this.createVbo(b,this.sizeFromData,b.DYNAMIC_DRAW),this.sizeTo=this.createVbo(b,this.sizeToData,b.DYNAMIC_DRAW),this.colorFrom=this.createVbo(b,this.colorFromData,b.DYNAMIC_DRAW),this.colorTo=this.createVbo(b,this.colorToData,b.DYNAMIC_DRAW)},rebind:function(a){this.transfarVbo(a,this.initialPosition,this.initialPositionData),this.transfarVbo(a,this.velocityFrom,this.velocityFromData),this.transfarVbo(a,this.velocityTo,this.velocityToData),this.transfarVbo(a,this.spawnTime,this.spawnTimeData),this.transfarVbo(a,this.active,this.activeData),this.transfarVbo(a,this.frameIndex,this.frameIndexData),this.transfarVbo(a,this.ttl,this.ttlData),this.transfarVbo(a,this.sizeFrom,this.sizeFromData),this.transfarVbo(a,this.sizeTo,this.sizeToData),this.transfarVbo(a,this.colorFrom,this.colorFromData),this.transfarVbo(a,this.colorTo,this.colorToData)},spawn:function(b,c){var d=a(this.activeData,0);return 0>d?(console.warn("パーティクルが足りない"),-1):(this.initialPositionData[2*d+0]=c.position.x,this.initialPositionData[2*d+1]=c.position.y,this.velocityFromData[2*d+0]=c.velocityFrom.x,this.velocityFromData[2*d+1]=c.velocityFrom.y,this.velocityToData[2*d+0]=c.velocityTo.x,this.velocityToData[2*d+1]=c.velocityTo.y,this.spawnTimeData[d]=b,this.activeData[d]=1,this.frameIndexData[d]=c.frameIndex,this.ttlData[d]=c.ttl,this.sizeFromData[d]=c.sizeFrom,this.sizeToData[d]=c.sizeTo,this.colorFromData[4*d+0]=c.colorFrom.r/255,this.colorFromData[4*d+1]=c.colorFrom.g/255,this.colorFromData[4*d+2]=c.colorFrom.b/255,this.colorFromData[4*d+3]=c.colorFrom.a,this.colorToData[4*d+0]=c.colorTo.r/255,this.colorToData[4*d+1]=c.colorTo.g/255,this.colorToData[4*d+2]=c.colorTo.b/255,this.colorToData[4*d+3]=c.colorTo.a,this.vboNeedUpdate=!0,d)},despawn:function(a){a<this.activeData.length&&(this.activeData[a]=0,this.vboNeedUpdate=!0)}});var a=function(a,b){return Array.prototype.indexOf.call(a,b)}}(),function(){tm.define("glb.ParticleMaterial",{superClass:"glb.Material",_image:null,texture:null,init:function(a){this.superInit(),this._image=a},build:function(a){this._createProgram(a),this._image&&(this.texture=a.createTexture(this._image))},_getVertexShaderSource:function(){return c},_getFragmentShaderSource:function(){return d},_getAttributeMetaData:function(){return a},_getUniformMetaData:function(){return b},setTextures:function(a){var b=a.gl;this.texture?(b.activeTexture(b.TEXTURE0),b.bindTexture(b.TEXTURE_2D,this.texture)):b.bindTexture(b.TEXTURE_2D,null)},setUniforms:function(a,b){this.superSetUniforms(a,b),this.setUniform(a,"useTexture",this.texture?1:0)},draw:function(a,b){var c=a.gl;c.disable(c.DEPTH_TEST),c.disable(c.CULL_FACE),c.blendFunc(c.SRC_ALPHA,c.ONE),c.drawArrays(c.POINTS,0,b),c.enable(c.DEPTH_TEST),c.enable(c.CULL_FACE),c.blendFunc(c.SRC_ALPHA,c.ONE_MINUS_SRC_ALPHA)}});var a=[{name:"initialPosition",size:2},{name:"velocityFrom",size:2},{name:"velocityTo",size:2},{name:"spawnTime",size:1},{name:"active",size:1},{name:"frameIndex",size:1},{name:"ttl",size:1},{name:"sizeFrom",size:1},{name:"sizeTo",size:1},{name:"colorFrom",size:4},{name:"colorTo",size:4}],b=[{name:"vpMatrix",type:"mat4"},{name:"time",type:"float"}],c=["attribute vec2 initialPosition;","attribute float spawnTime;","attribute float active;","attribute float frameIndex;","attribute float ttl;","attribute vec2 velocityFrom;","attribute vec2 velocityTo;","attribute float sizeFrom;","attribute float sizeTo;","attribute vec4 colorFrom;","attribute vec4 colorTo;","uniform mat4 vpMatrix;","uniform float time;","varying float vAge;","varying float vActive;","varying float vFrameIndex;","varying float vSize;","varying vec4 vColor;","float lerp(float from, float to, float time, float duration) {","    return from + (to - from) * time / duration;","}","vec2 lerp(vec2 from, vec2 to, float time, float duration) {","    return from + (to - from) * time / duration;","}","vec4 lerp(vec4 from, vec4 to, float time, float duration) {","    return from + (to - from) * time / duration;","}","void main(void) {","    vActive = active;","    vFrameIndex = frameIndex;","    if (active < 0.5) {","        gl_Position = vec4(0.0);","        gl_PointSize = 0.0;","    } else {","        vAge = time - spawnTime;","        vSize = lerp(sizeFrom, sizeTo, vAge, ttl);","        vColor = lerp(colorFrom, colorTo, vAge, ttl);","        vec2 v = lerp(velocityFrom, velocityTo, vAge, ttl);","        float tm = vAge * 10000.0;","        vec2 pos = initialPosition + velocityFrom * tm + (v - velocityFrom) * tm * 0.5;","        gl_Position = vpMatrix * vec4(pos, 0.0, 1.0);","        gl_PointSize = vSize * {0};".format(GL_QUALITY.toFloatString()),"    }","}"].join("\n"),d=["precision mediump float;","uniform sampler2D texture;","varying float vAge;","varying float vActive;","varying float vFrameIndex;","varying float vSize;","varying vec4 vColor;","void main(void) {","    if (vActive < 0.5) discard;","    vec2 uv = vec2((gl_PointCoord.x + vFrameIndex) * 0.0625, gl_PointCoord.y);","    gl_FragColor = vColor * texture2D(texture, uv);","}"].join("\n")}(),function(){tm.define("glb.ParticleSystem",{superClass:"glb.Object3D",geometry:null,material:null,particles:null,time:0,visible:!0,init:function(a){this.superInit(),this.geometry=glb.ParticleGeometry(),this.material=glb.ParticleMaterial(a),this.particles=[],this.time=0},build:function(a){var b=(a.gl,a.ext);this.geometry.build(a),this.material.build(a),null!==b&&(this.material.setVao(a),this.material.setAttributes(a,this.geometry),this.material.unsetVao(a))},update:function(a){this.time+=1e-4;var b=this,c=this.time;this.particles=this.particles.filter(function(a){return a.deathTime<=c?(b.despawn(a.index),!1):!0})},render:function(a,b){var c=a.gl,d=a.ext;this.geometry.vboNeedUpdate&&(this.geometry.rebind(c),this.geometry.vboNeedUpdate=!1),this.material.setProgram(a),null!==d?this.material.setVao(a):this.material.setAttributes(a,this.geometry),this.material.setTextures(a),this.material.setUniforms(a,this),this.material.setUniform(a,"time",this.time),this.material.setUniform(a,"vpMatrix",b),this.material.draw(a,this.geometry.COUNT),null!==d&&this.material.unsetVao(a)},spawn:function(b){var c=this.geometry.spawn(this.time,{}.$extend(a,b));if(!(0>c))return this.particles.push({deathTime:this.time+b.ttl,index:c}),c},despawn:function(a){this.geometry.despawn(a)}});var a={position:{x:0,y:0},frameIndex:0,ttl:.006,velocityFrom:{x:1,y:0},velocityTo:{x:0,y:0},sizeFrom:30,sizeTo:30,colorFrom:{r:255,g:255,b:255,a:1},colorTo:{r:255,g:255,b:255,a:0}}}(),tm.define("glb.GameScene",{superClass:"tm.app.Scene",_renderable:!0,glContext:null,init:function(){this.superInit(),console.log(tm.asset.Manager.get("hime")),this.fromJSON({children:{hud:{type:"glb.Hud",x:0,y:0}}}),this.screen=glb.Screen(256,256),this.effectComposer=null;var a=this.camera=glb.OrthoCamera(SCREEN_WIDTH*-.5,.5*SCREEN_WIDTH,SCREEN_HEIGHT*-.5,.5*SCREEN_HEIGHT,100,1e4);a.position.z=.5*SCREEN_HEIGHT/Math.tan(45*Math.DEG_TO_RAD*.5),a.updateMatrix();var b=glb.ShaderPass(glb.ReverseShader());b.enabled=!1,this.on("enter",function(a){a.app.background="transparent",this.glContext=a.app.glContext,this.bullets.build(this.glContext),this.screen.build(this.glContext),this.effectComposer=glb.AfterEffectComposer(this.glContext)});var c=this.player=glb.Mesh(tm.asset.Manager.get("hime").geometry,glb.BasicMaterial({image:tm.asset.Manager.get("himetex").element})).setScale(5,5,5).setPosition(0,-200,0).addChildTo(this);c.on("enterframe",function(a){this.rotateY(.06);var b=a.app.keyboard.getKeyDirection();this.x+=4*b.x,this.y-=4*b.y;var c=a.app.pointing;if(c.getPointing()){var d=c.deltaPosition;this.x+=2*d.x,this.y-=2*d.y}}),c.on("hit",function(){glb.ExplosionS(f).setPosition(this.x,this.y,0).addChildTo(this),b.enabled=!0,this.tweener.clear().wait(50).call(function(){b.enabled=!1})});var d=this.bullets=glb.Bullets(tm.asset.Manager.get("bullets").element).addChildTo(this);tm.display.Label("bullet count = 0",40).setAlign("left").setFillStyle("darkgreen").setPosition(10,30).addChildTo(this).on("enterframe",function(){this.text="bullet count = "+d.bullets.length}),this.on("enterframe",function(a){if(a.app.frame%3===0){var b=2;b.times(function(c){d.spawn(glb.Vector2(100*Math.cos(a.app.frame*-.042),100*Math.sin(a.app.frame*-.042)),glb.Vector2().fromAngleLength(.06*a.app.frame+2*Math.PI*c/b,3),0),d.spawn(glb.Vector2(100*Math.cos(.042*a.app.frame),100*Math.sin(.042*a.app.frame)),glb.Vector2().fromAngleLength(a.app.frame*-.06+2*Math.PI*c/b,3.5),4)})}});var e=tm.display.RectangleShape({width:5,height:5,fillStyle:"rgba(255,0,0,0.8)",strokeStyle:"transparent"}).addChildTo(this).on("enterframe",function(){var b=a.getScreenCoord(c);this.setPosition(b.x*SCREEN_WIDTH,(1-b.y)*SCREEN_HEIGHT)});this.pixels=new Uint8Array(4),this.on("enterframe",function(a){this.pixels[0]&&this.pixels[3]?(e.setScale(5),c.flare("hit")):e.setScale(1)});var f=glb.ParticleSystem(tm.asset.Manager.get("particles").element).addChildTo(this);tm.display.Label("particle count = 0",40).setAlign("left").setFillStyle("darkgreen").setPosition(10,60).addChildTo(this).on("enterframe",function(){this.text="particle count = "+f.particles.length})},draw:function(){var a=this.glContext.gl,b=this.bullets;this.bullets.switchMaterial(!1),this.children.forEach(function(a){a._visibleBkup=a.visible,a.visible=a===b}),this.glContext.attachScreen(this.screen),this.glContext.render(this,this.camera);var c=this.camera.getScreenCoord(this.player);a.readPixels(~~(c.x*this.screen.width),~~(c.y*this.screen.height),1,1,a.RGBA,a.UNSIGNED_BYTE,this.pixels),this.bullets.switchMaterial(!0),this.children.forEach(function(a){a.visible=a._visibleBkup}),this.effectComposer.render(this,this.camera)}});
//# sourceMappingURL=game.js.map